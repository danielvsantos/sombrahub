{% extends "base.html" %}

{% block title %}Dashboard - Sombra Hub{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-3xl font-bold" data-testid="text-page-title">Dashboard</h1>
    <p class="text-base-content/60 mt-1">Welcome back, {{ current_user.username }}</p>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
    <div class="stat-card rounded-xl p-5" data-testid="stat-total-deals">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-base-content/60 text-sm">Total Deals</p>
                <p class="text-3xl font-bold mt-1">{{ total_deals }}</p>
            </div>
            <div class="w-12 h-12 rounded-xl bg-purple-500/20 flex items-center justify-center">
                <i class="fas fa-handshake text-xl text-purple-400"></i>
            </div>
        </div>
    </div>
    
    <div class="stat-card rounded-xl p-5" data-testid="stat-active-jobs">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-base-content/60 text-sm">Active Jobs</p>
                <p class="text-3xl font-bold mt-1">{{ active_jobs }}</p>
            </div>
            <div class="w-12 h-12 rounded-xl bg-blue-500/20 flex items-center justify-center">
                <i class="fas fa-briefcase text-xl text-blue-400"></i>
            </div>
        </div>
    </div>
    
    <div class="stat-card rounded-xl p-5" data-testid="stat-pending-deliverables">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-base-content/60 text-sm">Pending Deliverables</p>
                <p class="text-3xl font-bold mt-1">{{ pending_deliverables }}</p>
            </div>
            <div class="w-12 h-12 rounded-xl bg-amber-500/20 flex items-center justify-center">
                <i class="fas fa-tasks text-xl text-amber-400"></i>
            </div>
        </div>
    </div>
    
    <div class="stat-card rounded-xl p-5" data-testid="stat-won-value">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-base-content/60 text-sm">Won Deals Value</p>
                <p class="text-3xl font-bold mt-1">${{ "{:,.0f}".format(won_deals_value) }}</p>
            </div>
            <div class="w-12 h-12 rounded-xl bg-green-500/20 flex items-center justify-center">
                <i class="fas fa-dollar-sign text-xl text-green-400"></i>
            </div>
        </div>
    </div>
</div>

<div class="card bg-base-200 shadow-lg mb-6">
    <div class="card-body">
        <div class="flex items-center justify-between mb-4">
            <h2 class="card-title text-lg">
                <i class="fas fa-tasks text-amber-400"></i>
                My Tasks
            </h2>
        </div>
        
        {% if my_tasks %}
        <div class="overflow-x-auto">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Task</th>
                        <th>Job</th>
                        <th>Status</th>
                        <th>Due Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in my_tasks %}
                    <tr class="hover:bg-base-300/50" data-testid="row-my-task-{{ task.id }}">
                        <td class="font-medium">
                            <a href="{{ url_for('job_detail', job_id=task.job_id) }}" class="hover:text-primary">
                                {{ task.title }}
                            </a>
                        </td>
                        <td class="text-base-content/70">
                            <a href="{{ url_for('job_detail', job_id=task.job_id) }}" class="hover:text-primary">
                                {{ task.job.display_title }}
                            </a>
                        </td>
                        <td>
                            <span class="badge badge-sm 
                                {% if task.status == 'To Do' %}badge-ghost
                                {% elif task.status == 'Shooting' %}badge-info
                                {% elif task.status == 'Editing' %}badge-warning
                                {% elif task.status == 'Review' %}badge-accent
                                {% else %}badge-success{% endif %}">
                                {{ task.status }}
                            </span>
                        </td>
                        <td class="{% if task.due_date and task.due_date < today %}text-error{% else %}text-base-content/60{% endif %}">
                            {% if task.due_date %}
                            {{ task.due_date.strftime('%b %d, %Y') }}
                            {% else %}
                            <span class="text-base-content/40">No date</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-8 text-base-content/60">
            <i class="fas fa-check-circle text-4xl mb-3 opacity-50"></i>
            <p>No tasks assigned to you</p>
        </div>
        {% endif %}
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="card bg-base-200 shadow-lg">
        <div class="card-body">
            <div class="flex items-center justify-between mb-4">
                <h2 class="card-title text-lg">
                    <i class="fas fa-history text-purple-400"></i>
                    Recent Proposals
                </h2>
                <a href="{{ url_for('deals') }}" class="btn btn-ghost btn-sm gap-1" data-testid="link-view-all-deals">
                    View all <i class="fas fa-arrow-right text-xs"></i>
                </a>
            </div>
            
            {% if recent_deals %}
            <div class="space-y-3">
                {% for deal in recent_deals %}
                <div class="flex items-center justify-between p-3 rounded-lg bg-base-300/50 hover:bg-base-300 transition-colors" data-testid="card-recent-deal-{{ deal.id }}">
                    <div class="flex items-center gap-3">
                        <div class="avatar placeholder">
                            <div class="bg-{{ 'purple' if deal.stage == 'New' else 'amber' if deal.stage == 'Proposal' else 'blue' if deal.stage == 'Negotiation' else 'green' if deal.stage == 'Won' else 'red' }}-500/20 rounded-lg w-10">
                                <span class="text-sm">{{ deal.client.name[0] }}</span>
                            </div>
                        </div>
                        <div>
                            <p class="font-medium text-sm">{{ deal.title }}</p>
                            <p class="text-xs text-base-content/60">{{ deal.client.name }}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-semibold text-sm">${{ "{:,.0f}".format(deal.value) }}</p>
                        <span class="badge badge-sm 
                            {% if deal.stage == 'New' %}badge-info
                            {% elif deal.stage == 'Proposal' %}badge-warning
                            {% elif deal.stage == 'Negotiation' %}badge-accent
                            {% elif deal.stage == 'Won' %}badge-success
                            {% else %}badge-error{% endif %}">
                            {{ deal.stage }}
                        </span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-8 text-base-content/60">
                <i class="fas fa-inbox text-4xl mb-3 opacity-50"></i>
                <p>No deals yet</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <div class="card bg-base-200 shadow-lg">
        <div class="card-body">
            <div class="flex items-center justify-between mb-4">
                <h2 class="card-title text-lg">
                    <i class="fas fa-calendar-alt text-blue-400"></i>
                    Upcoming Deliverables
                </h2>
                <a href="{{ url_for('production') }}" class="btn btn-ghost btn-sm gap-1" data-testid="link-view-all-deliverables">
                    View all <i class="fas fa-arrow-right text-xs"></i>
                </a>
            </div>
            
            {% if upcoming_deliverables %}
            <div class="space-y-3">
                {% for deliverable in upcoming_deliverables %}
                <div class="flex items-center justify-between p-3 rounded-lg bg-base-300/50 hover:bg-base-300 transition-colors" data-testid="card-upcoming-deliverable-{{ deliverable.id }}">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-base-100 flex items-center justify-center">
                            <i class="fas fa-file-image text-base-content/60"></i>
                        </div>
                        <div>
                            <p class="font-medium text-sm">{{ deliverable.title }}</p>
                            <p class="text-xs text-base-content/60">{{ deliverable.job.client.name }}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        {% if deliverable.due_date %}
                        <p class="text-sm {% if deliverable.due_date < today %}text-error{% else %}text-base-content/60{% endif %}">
                            {{ deliverable.due_date.strftime('%b %d') }}
                        </p>
                        {% endif %}
                        <span class="badge badge-sm 
                            {% if deliverable.status == 'To Do' %}badge-ghost
                            {% elif deliverable.status == 'Shooting' %}badge-info
                            {% elif deliverable.status == 'Editing' %}badge-warning
                            {% elif deliverable.status == 'Review' %}badge-accent
                            {% else %}badge-success{% endif %}">
                            {{ deliverable.status }}
                        </span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-8 text-base-content/60">
                <i class="fas fa-check-circle text-4xl mb-3 opacity-50"></i>
                <p>All caught up!</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-4">
    <a href="{{ url_for('deals') }}" class="card bg-gradient-to-br from-purple-500/10 to-purple-600/5 border border-purple-500/20 hover:border-purple-500/40 transition-all group" data-testid="card-quick-deals">
        <div class="card-body">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-purple-500/20 flex items-center justify-center group-hover:scale-110 transition-transform">
                    <i class="fas fa-plus text-purple-400"></i>
                </div>
                <div>
                    <h3 class="font-semibold">Add New Proposal</h3>
                    <p class="text-sm text-base-content/60">Start a new opportunity</p>
                </div>
            </div>
        </div>
    </a>
    
    <a href="{{ url_for('production') }}" class="card bg-gradient-to-br from-blue-500/10 to-blue-600/5 border border-blue-500/20 hover:border-blue-500/40 transition-all group" data-testid="card-quick-production">
        <div class="card-body">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-blue-500/20 flex items-center justify-center group-hover:scale-110 transition-transform">
                    <i class="fas fa-eye text-blue-400"></i>
                </div>
                <div>
                    <h3 class="font-semibold">View Jobs</h3>
                    <p class="text-sm text-base-content/60">Manage active jobs</p>
                </div>
            </div>
        </div>
    </a>
    
    <a href="{{ url_for('clients') }}" class="card bg-gradient-to-br from-green-500/10 to-green-600/5 border border-green-500/20 hover:border-green-500/40 transition-all group" data-testid="card-quick-clients">
        <div class="card-body">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-green-500/20 flex items-center justify-center group-hover:scale-110 transition-transform">
                    <i class="fas fa-user-plus text-green-400"></i>
                </div>
                <div>
                    <h3 class="font-semibold">Add Client</h3>
                    <p class="text-sm text-base-content/60">Grow your network</p>
                </div>
            </div>
        </div>
    </a>
</div>
{% endblock %}
