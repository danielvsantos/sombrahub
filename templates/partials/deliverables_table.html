<div class="flex items-center justify-between mb-4">
    <h4 class="font-semibold text-base-content/80">Tasks</h4>
    <button onclick="openAddDeliverableModal({{ job.id }})" class="btn btn-sm btn-primary gap-1" data-testid="button-add-deliverable-{{ job.id }}">
        <i class="fas fa-plus text-xs"></i>
        Add
    </button>
</div>

{% if job.deliverables %}
<div class="overflow-x-auto">
    <table class="table table-sm">
        <thead>
            <tr class="text-base-content/60">
                <th>Title</th>
                <th>Label</th>
                <th>Status</th>
                <th>Assignees</th>
                <th>Due Date</th>
                <th>File</th>
                <th class="w-16"></th>
            </tr>
        </thead>
        <tbody>
            {% for deliverable in job.deliverables %}
            <tr class="hover:bg-base-300/30" data-testid="row-deliverable-{{ deliverable.id }}">
                <td class="font-medium">{{ deliverable.title }}</td>
                <td>
                    {% if deliverable.label %}
                    <span class="badge badge-{{ deliverable.label.color }} badge-sm">{{ deliverable.label.name }}</span>
                    {% else %}
                    <span class="text-base-content/40 text-sm">-</span>
                    {% endif %}
                </td>
                <td>
                    <form hx-post="{{ url_for('update_deliverable_status', deliverable_id=deliverable.id) }}" hx-trigger="change" hx-swap="none">
                        <select name="status" class="select select-bordered select-sm bg-base-300/50 min-w-32" data-testid="select-status-{{ deliverable.id }}">
                            {% for status in ['To Do', 'In Progress', 'Review', 'Done'] %}
                            <option value="{{ status }}" {% if deliverable.status == status %}selected{% endif %}>
                                {{ status }}
                            </option>
                            {% endfor %}
                        </select>
                    </form>
                </td>
                <td>
                    {% set assignees = deliverable.all_assignees %}
                    {% if assignees %}
                    <div class="flex items-center -space-x-1">
                        {% for user in assignees[:3] %}
                        <div class="avatar placeholder" title="{{ user.full_name or user.username }}">
                            <div class="bg-purple-500/20 text-purple-400 rounded-full w-6 border border-base-100">
                                <span class="text-xs">{{ user.username[0].upper() }}</span>
                            </div>
                        </div>
                        {% endfor %}
                        {% if assignees|length > 3 %}
                        <span class="text-base-content/60 text-sm pl-2">+{{ assignees|length - 3 }}</span>
                        {% endif %}
                    </div>
                    {% else %}
                    <span class="text-base-content/40 text-sm">Unassigned</span>
                    {% endif %}
                </td>
                <td>
                    {% if deliverable.due_date %}
                    <span class="text-sm {% if deliverable.due_date < today %}text-error{% endif %}">
                        {{ deliverable.due_date.strftime('%b %d, %Y') }}
                    </span>
                    {% else %}
                    <span class="text-base-content/40 text-sm">No date</span>
                    {% endif %}
                </td>
                <td>
                    {% if deliverable.file_name %}
                    <a href="{{ url_for('get_deliverable_file', deliverable_id=deliverable.id) }}" class="btn btn-ghost btn-xs text-primary" title="{{ deliverable.file_original_name }}" target="_blank" data-testid="link-file-{{ deliverable.id }}">
                        <i class="fas fa-paperclip"></i>
                    </a>
                    {% else %}
                    <span class="text-base-content/40 text-sm">-</span>
                    {% endif %}
                </td>
                <td>
                    <div class="flex gap-1">
                        <button type="button" 
                                onclick="openEditTaskModal({{ deliverable.id }}, {{ job.id }}, 'production', '#deliverables-{{ job.id }}')" 
                                class="btn btn-ghost btn-xs" 
                                data-testid="button-edit-{{ deliverable.id }}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <form hx-post="{{ url_for('delete_deliverable', deliverable_id=deliverable.id) }}" hx-target="#deliverables-{{ job.id }}" hx-swap="innerHTML" hx-confirm="Delete this task?">
                            <button type="submit" class="btn btn-ghost btn-xs text-error" data-testid="button-delete-{{ deliverable.id }}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="text-center py-8 text-base-content/40 bg-base-300/30 rounded-lg">
    <i class="fas fa-tasks text-3xl mb-2"></i>
    <p class="text-sm">No tasks yet</p>
    <button onclick="openAddDeliverableModal({{ job.id }})" class="btn btn-sm btn-ghost mt-2 gap-1">
        <i class="fas fa-plus text-xs"></i>
        Add your first task
    </button>
</div>
{% endif %}

{% if job.status == 'Active' and job.deliverables %}
<div class="mt-4 pt-4 border-t border-base-300 flex justify-end">
    <form action="{{ url_for('complete_job', job_id=job.id) }}" method="POST">
        <button type="submit" class="btn btn-success btn-sm gap-2" data-testid="button-complete-job-{{ job.id }}">
            <i class="fas fa-check-circle"></i>
            Mark Job Complete
        </button>
    </form>
</div>
{% endif %}
